<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='utf-8'>
    <title>NW Crest Designer</title>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <meta content='Jasper Catthoor' name='author'>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            background-color: #2c3e50;
        }

        #container {
            display: flex;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 50px;
            box-sizing: border-box;
        }

        #foreground-images-container {
            flex: 1 1 25%;
        }

        #foreground-colors-container, #background-colors-container {
            flex: 0 0 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #background-images-container {
            flex: 1 1 25%;
        }

        #canvas-container {
            flex: 0 0 500px;

            display: flex;
            align-items: center;
            justify-content: center;
        }

        #canvas-background, #canvas-foreground {
            position: fixed;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="foreground-images-container"></div>
    <div id="foreground-colors-container"></div>
    <div id="canvas-container">
        <canvas id="canvas-background"></canvas>
        <canvas id="canvas-foreground"></canvas>
    </div>
    <div id="background-colors-container"></div>
    <div id="background-images-container"></div>
</div>
<script type='module'>
    const foregroundImagesContainer = document.getElementById('foreground-images-container');
    const backgroundImagesContainer = document.getElementById('background-images-container');

    const foregroundImagePaths = await (await fetch('get-small-foreground-images-paths')).json();
    const backgroundImagePaths = await (await fetch('get-small-background-images-paths')).json();

    const foregroundColorsContainer = document.getElementById('foreground-colors-container');
    const backgroundColorsContainer = document.getElementById('background-colors-container');

    const foregroundColors = {
        'FG Red': '#c31818',
        'FG Orange': '#ca5711',
        'FG Yellow': '#d7a819',
        'FG Green': '#5f9c36',
        'FG Teal': '#33bbb9',
        'FG Blue': '#587cbc',
        'FG Deep Blue': '#2516b6',
        'FG Pink': '#a74f8f',
        'FG White': '#eeefed',
        'FG Dark Red': '#3e141c',
        'FG Dark Orange': '#b96d24',
        'FG Dark Yellow': '#5c5545',
        'FG Dark Green': '#2a4f29',
        'FG Dark Teal': '#006e5d',
        'FG Dark Blue': '#004e97',
        'FG Washed Dark Purple': '#1c3269',
        'FG Dark Pink': '#321d25',
        'FG Black': '#222222'
    };
    const backgroundColors = {
        'Syndicate variant 1': '#8732d3',
        'Syndicate variant 2': '#6e28ad',
        'Syndicate variant 3': '#551f85',
        'Marauder variant 1': '#149633',
        'Marauder variant 2': '#097122',
        'Marauder variant 3': '#093e16',
        'Covenant variant 1': '#eb9f0d',
        'Covenant variant 2': '#b47c12',
        'Covenant variant 3': '#895f0d'
    };

    let currentForegroundColor = foregroundColors['FG White'];
    let currentBackgroundColor = backgroundColors['Covenant variant 1'];
    let currentForegroundImage = foregroundImagePaths[0].replace('_small.png', '.png').replace('\/small\/', '/large/');
    let currentBackgroundImage = backgroundImagePaths[0].replace('_small.png', '.png').replace('\/small\/', '/large/');

    foregroundImagePaths.forEach(foregroundImagePath => {
        const image = document.createElement('img');
        image.src = foregroundImagePath;
        image.onclick = () => {
            currentForegroundImage = foregroundImagePath.replace('_small.png', '.png').replace('\/small\/', '/large/');
            renderForeground();
        }
        foregroundImagesContainer.appendChild(image);
    });

    backgroundImagePaths.forEach(backgroundImagePath => {
        const image = document.createElement('img');
        image.src = backgroundImagePath;
        image.onclick = () => {
            currentBackgroundImage = backgroundImagePath.replace('_small.png', '.png').replace('\/small\/', '/large/');
            renderBackground();
        }
        backgroundImagesContainer.appendChild(image);
    });

    Object.values(foregroundColors).forEach(color => {
        const box = document.createElement('div');
        box.style.width = '50px';
        box.style.height = '50px';
        box.style.backgroundColor = color;
        box.onclick = () => {
            currentForegroundColor = color;
            renderForeground();
        }
        foregroundColorsContainer.appendChild(box);
    });

    Object.values(backgroundColors).forEach(color => {
        const box = document.createElement('div');
        box.style.width = '50px';
        box.style.height = '50px';
        box.style.backgroundColor = color;
        box.onclick = () => {
            currentBackgroundColor = color;
            renderBackground();
        }
        backgroundColorsContainer.appendChild(box);
    });

    const canvasBackground = document.getElementById('canvas-background');
    const canvasForeground = document.getElementById('canvas-foreground');
    const ctxBackground = canvasBackground.getContext('2d');
    const ctxForeground = canvasForeground.getContext('2d');

    function renderBackground() {
        const color = parseInt(currentBackgroundColor.slice(1), 16);

        const image = new Image();
        image.onload = ({path: [img]}) => {
            canvasBackground.width = img.width;
            canvasBackground.height = img.height;

            ctxBackground.drawImage(image, 0, 0);

            const imageData = ctxBackground.getImageData(0, 0, img.width, img.height);
            const imagePixels = imageData.data;
            for (let i = 0; i < img.height * img.width * 4; i += 4) {
                const r = imagePixels[i];
                const g = imagePixels[i + 1];
                const b = imagePixels[i + 2];
                const a = imagePixels[i + 3];

                if (r > 0x20 && g > 0x20 && b > 0x20) {
                    if (a > 0x80) {
                        imagePixels[i] = ((color & 0xff0000) >> 16);
                        imagePixels[i + 1] = ((color & 0x00ff00) >> 8);
                        imagePixels[i + 2] = color & 0x0000ff;
                    }
                }
            }

            ctxBackground.putImageData(imageData, 0, 0);
        };
        image.src = currentBackgroundImage;
    }

    function renderForeground() {
        const color = parseInt(currentForegroundColor.slice(1), 16);

        const image = new Image();
        image.onload = ({path: [img]}) => {
            canvasForeground.width = img.width;
            canvasForeground.height = img.height;

            ctxForeground.drawImage(image, 0, 0);

            const imageData = ctxForeground.getImageData(0, 0, img.width, img.height);
            const imagePixels = imageData.data;
            for (let i = 0; i < img.height * img.width * 4; i += 4) {
                const r = imagePixels[i];
                const g = imagePixels[i + 1];
                const b = imagePixels[i + 2];
                const a = imagePixels[i + 3];

                if (r > 0x20 && g > 0x20 && b > 0x20) {
                    if (a > 0x80) {
                        imagePixels[i] = ((color & 0xff0000) >> 16);
                        imagePixels[i + 1] = ((color & 0x00ff00) >> 8);
                        imagePixels[i + 2] = color & 0x0000ff;
                    }
                }
            }

            ctxForeground.putImageData(imageData, 0, 0);
        };
        image.src = currentForegroundImage;
    }

    renderBackground(currentBackgroundColor);
    renderForeground(currentForegroundColor);
</script>
</body>
</html>
